# Процесс взаимодействия партнера с системой

## Обзор системы

Система представляет собой Telegram-бота, интегрированного с Bitrix24, который позволяет партнерам:
- Авторизоваться по телефону и коду партнера
- Получать статистику по своим сделкам в реальном времени
- Видеть расчет своей доли от общей суммы сделок

---

## Процесс в Telegram-боте

### 1. Запуск бота

**Действие партнера:** Отправляет команду `/start`

**Что происходит:**
- Бот проверяет наличие регистрации партнера в локальной базе данных SQLite
- Если партнер уже зарегистрирован → переход к шагу 6 (авторизация)
- Если партнер новый → переход к шагу 2 (регистрация)

---

### 2. Запрос номера телефона

**Действие партнера:** Отправляет номер телефона (через кнопку "Поделиться контактом" или вводом вручную)

**Что происходит:**
- Валидация формата номера (10-15 цифр)
- Нормализация номера (удаление пробелов, скобок, дефисов)
- Генерация вариантов номера для поиска (с/без кода страны, с/без +)

**Результат:** Номер нормализован и готов к поиску в Bitrix24

---

### 3. Поиск партнера в Bitrix24

**Что происходит в Bitrix24:**

#### 3.1. Поиск среди контактов
- Запрос к API `crm.contact.list` с фильтром по номеру телефона
- Проверка типа контакта (`TYPE_ID` должен быть `PARTNER`)
- Проверка наличия кода партнера в кастомном поле (`PARTNER_CONTACT_CODE_FIELD`)
- Извлечение процента партнера из кастомного поля (`PARTNER_CONTACT_PERCENT_FIELD`)

#### 3.2. Поиск среди компаний (если не найден в контактах)
- Запрос к API `crm.company.list` с фильтром по номеру телефона
- Проверка типа компании (`COMPANY_TYPE` должен быть `PARTNER`)
- Проверка наличия кода партнера в кастомном поле (`PARTNER_COMPANY_CODE_FIELD`)
- Извлечение процента партнера из кастомного поля (`PARTNER_COMPANY_PERCENT_FIELD`)

**Результат:**
- ✅ Партнер найден → сохранение `bitrix_contact_id`, `partner_code`, `partner_percent`, `entity_type` (C_ для контакта, CO_ для компании)
- ❌ Партнер не найден → сообщение об ошибке, процесс останавливается

---

### 4. Запрос кода партнера

**Действие партнера:** Отправляет код партнера (3-32 символа: A-Z, 0-9, -, _)

**Что происходит:**
- Валидация формата кода
- Нормализация кода (приведение к верхнему регистру)
- Сравнение с кодом, полученным из Bitrix24

**Результат:**
- ✅ Код совпадает → переход к шагу 5 (сохранение)
- ❌ Код не совпадает → сообщение об ошибке, повторный запрос

---

### 5. Сохранение данных партнера

**Что происходит:**
- Создание объекта `PartnerSubmission` с данными:
  - `user_id` - ID пользователя Telegram
  - `username`, `first_name`, `last_name` - данные профиля Telegram
  - `phone_number` - нормализованный номер телефона
  - `partner_code` - код партнера
  - `bitrix_contact_id` - ID контакта/компании в Bitrix24
  - `bitrix_entity_type` - тип сущности (C_ или CO_)
- Сохранение в таблицу `partner_requests` в SQLite
- Создание уникального индекса по `user_id` (гарантия одной регистрации на пользователя)
- Сохранение состояния авторизации в FSM (Finite State Machine)

**Результат:** Партнер авторизован, получает клавиатуру со статистикой

---

### 6. Авторизация существующего партнера

**Что происходит (если партнер уже в базе):**
- Извлечение данных из базы (`bitrix_contact_id`, `bitrix_entity_type`)
- Запрос процента партнера из Bitrix24 (если не сохранен)
- Установка состояния `authorized` в FSM
- Сохранение данных в FSM для быстрого доступа

**Результат:** Партнер сразу получает клавиатуру со статистикой без повторного ввода данных

---

### 7. Запрос статистики

**Действие партнера:** Нажимает кнопку:
- "Статистика за сегодня"
- "Статистика за неделю"
- "Статистика за всё время"

**Что происходит:**

#### 7.1. Определение периода
- `today` - с начала текущего дня (00:00:00 UTC)
- `week` - последние 7 дней
- `all` - все сделки без ограничения по дате

#### 7.2. Построение запроса к Bitrix24
- Определение формата привязки партнера:
  - Для контакта: `C_{bitrix_contact_id}`
  - Для компании: `CO_{bitrix_contact_id}`
- Формирование фильтра для `crm.deal.list`:
  - Поле `PARTNER_DEAL_REF_DEAL` должно содержать привязку партнера
  - Если указан период → фильтр по `DATE_CREATE >= дата_начала`

#### 7.3. Получение сделок из Bitrix24
- Запрос к API `crm.deal.list` с фильтром
- Выборка полей: `STAGE_ID`, `OPPORTUNITY` (сумма сделки)

#### 7.4. Классификация сделок
- **Успешные** (`STAGE_ID` содержит `WON` или `SUCCESS`):
  - Счетчик успешных сделок
  - Сумма успешных сделок
- **Проваленные** (`STAGE_ID` содержит `LOSE` или `FAILED`):
  - Счетчик проваленных сделок
  - Сумма проваленных сделок
- **В работе** (все остальные стадии):
  - Счетчик сделок в работе
  - Сумма сделок в работе

#### 7.5. Расчет статистики
- Общая сумма всех сделок
- Количество сделок по категориям
- Расчет доли партнера: `общая_сумма × (процент_партнера / 100)`

#### 7.6. Формирование ответа
```
Статистика за [период]
В работе: [количество] (сумма [сумма])
Успешно: [количество] (сумма [сумма])
Провалено: [количество] (сумма [сумма])
Итого: [общая_сумма]
Ваш процент: [процент]%
Сумма по проценту: [доля_партнера]
```

---

## Процесс в Bitrix24

### Настройка полей

#### Для контактов:
- **Код партнера:** Кастомное поле `PARTNER_CONTACT_CODE_FIELD` (например, `UF_CRM_1763569646984`)
- **Процент партнера:** Кастомное поле `PARTNER_CONTACT_PERCENT_FIELD` (например, `UF_CRM_1763569663555`)
- **Тип контакта:** `TYPE_ID` должен быть равен `PARTNER`

#### Для компаний:
- **Код партнера:** Кастомное поле `PARTNER_COMPANY_CODE_FIELD` (например, `UF_CRM_1763568023604`)
- **Процент партнера:** Кастомное поле `PARTNER_COMPANY_PERCENT_FIELD` (например, `UF_CRM_1763568055347`)
- **Тип компании:** `COMPANY_TYPE` должен быть равен `PARTNER`

#### Для сделок:
- **Привязка партнера:** Кастомное поле `PARTNER_DEAL_REF_DEAL` (например, `UF_CRM_691DEDD76B4F0`)
- Формат значения:
  - Для контакта: `C_{ID_контакта}`
  - Для компании: `CO_{ID_компании}`

---

### Создание партнера в Bitrix24

#### Вариант 1: Создание контакта-партнера
1. Создать контакт в Bitrix24
2. Указать номер телефона
3. Установить тип контакта: `PARTNER`
4. Заполнить кастомное поле кода партнера (например, `ABC123`)
5. Заполнить кастомное поле процента партнера (например, `15.5`)

#### Вариант 2: Создание компании-партнера
1. Создать компанию в Bitrix24
2. Указать номер телефона
3. Установить тип компании: `PARTNER`
4. Заполнить кастомное поле кода партнера (например, `XYZ789`)
5. Заполнить кастомное поле процента партнера (например, `20.0`)

---

### Привязка сделки к партнеру

1. Создать сделку в Bitrix24
2. В кастомном поле `PARTNER_DEAL_REF_DEAL` указать:
   - `C_{ID_контакта}` - если партнер является контактом
   - `CO_{ID_компании}` - если партнер является компанией
3. Указать сумму сделки в поле `OPPORTUNITY`
4. Установить стадию сделки (`STAGE_ID`)

**Пример:**
- Партнер-контакт с ID `123` → в сделке указать `C_123`
- Партнер-компания с ID `456` → в сделке указать `CO_456`

---

## Схема взаимодействия

```
┌─────────────┐
│   Партнер   │
│  Telegram   │
└──────┬──────┘
       │
       │ /start
       ▼
┌─────────────────┐
│  Telegram Bot   │
│  (aiogram 3)    │
└──────┬──────────┘
       │
       ├──► Проверка в SQLite
       │    (локальная БД)
       │
       ├──► Запрос телефона
       │
       ├──► Поиск в Bitrix24
       │    ┌──────────────┐
       │    │  Bitrix24    │
       │    │  REST API    │
       │    └──────────────┘
       │    • crm.contact.list
       │    • crm.company.list
       │
       ├──► Запрос кода партнера
       │
       ├──► Сохранение в SQLite
       │
       └──► Запрос статистики
            │
            └──► Bitrix24 API
                 • crm.deal.list
                 • Фильтр по PARTNER_DEAL_REF_DEAL
                 • Расчет статистики
```

---

## Особенности реализации

### Безопасность
- Код партнера проверяется на соответствие значению в Bitrix24
- Один пользователь Telegram может быть зарегистрирован только один раз
- Номер телефона нормализуется для предотвращения дубликатов

### Производительность
- Использование `lru_cache` для кэширования сервиса Bitrix24
- Асинхронные запросы к Bitrix24 через `fast_bitrix24`
- Индексы в SQLite для быстрого поиска по `user_id`

### Гибкость
- Поддержка партнеров как контактов, так и компаний
- Настраиваемые поля через переменные окружения
- Поддержка различных форматов номеров телефонов

---

## Команды бота

- `/start` - Начать работу с ботом (регистрация или авторизация)
- `/cancel` или `/stop` - Отменить текущий процесс регистрации

---

## Состояния диалога (FSM)

1. **`phone`** - Ожидание номера телефона
2. **`partner_code`** - Ожидание кода партнера
3. **`authorized`** - Партнер авторизован, может запрашивать статистику

---

## Обработка ошибок

- **Bitrix24 недоступен:** Сообщение партнеру о временной недоступности
- **Партнер не найден:** Сообщение с просьбой уточнить данные
- **Неверный код:** Сообщение о несовпадении кода, повторный запрос
- **Ошибка базы данных:** Логирование ошибки, сообщение пользователю

