# Архитектура проекта

## Общее описание
Бот построен на `aiogram 3` и работает поверх `asyncio`. Состояние диалога управляется через FSM, данные сохраняются в SQLite через `aiosqlite`, конфигурация загружается из `.env`, логирование выполнено через `loguru`.

## Структура
- `main.py` — точка входа. Загружает настройки, инициализирует логирование, базу данных, бота и диспетчер, запускает polling.
- `pyproject.toml` — управление зависимостями и метаданными проекта.
- `.env.example` — образец переменных окружения (`BOT_TOKEN`, `DATABASE_PATH`, `LOG_LEVEL`).
- `README.md` — инструкции по настройке и запуску.
- `logs/` — создаётся автоматически для хранения файлов логов (`bot.log`).
- `storage/` — создаётся автоматически, содержит SQLite-файл по умолчанию.

### Пакет `app`
- `app/__init__.py` — метаданные пакета.
- `app/config.py` — загрузка настроек из окружения, подготовка пути к базе и Bitrix: сюда попадают идентификаторы кастомных полей контактов/компаний/сделок (`PARTNER_*`), чтобы весь код читал их только из `.env`.
- `app/logger.py` — конфигурация `loguru` (stdout + ротация файлов).

#### `app/bot`
- `app/bot/__init__.py` — фабрики `Bot` и `Dispatcher`, подключение роутеров и middleware.
- `app/bot/handlers.py` — FSM-сценарий: запрос телефона, проверка, запрос кода партнёра, сохранение в БД, обработка `/cancel`. Команда `/start` сперва проверяет наличие `user_id` в базе: если заявка уже есть, состояние переводится в `authorized`, в FSM сохраняются `bitrix_contact_id` и процент партнёра, пользователю сразу выдаётся клавиатура статистики без повторного ввода данных. При запросе статистики подтягивается процент (из FSM или Bitrix) и выводится расчёт доли партнёра от общей суммы сделок.
- `app/bot/keyboards.py` — клавиатура для запроса контакта и утилиты скрытия клавиатуры.

#### `app/db`
- `app/db/database.py` — класс `Database` с инициализацией схемы, сохранением заявок и выборкой последних записей. При старте применяется уникальный индекс `uq_partner_requests_user` и метод `get_submission_by_user`, чтобы гарантировать однократную регистрацию каждого `user_id` и быстро извлекать связанные данные (телефон, Bitrix ID, временные метки).

#### `app/middlewares`
- `app/middlewares/database.py` — middleware, пробрасывающее экземпляр `Database` в хэндлеры.

#### `app/services`
- `app/services/models.py` — dataclass `PartnerSubmission` (ID пользователя, данные Telegram и Bitrix).
- `app/services/stats.py` — функции подсчёта статистики сделок (сегодня/неделя/всё время) через Bitrix. Выборка использует поле, указанное в конфигурации (`PARTNER_DEAL_REF_DEAL`), чтобы можно было без кода менять привязку сделок к контактам или компаниям.

#### `app/utils`
- `app/utils/validators.py` — нормализация и проверка телефона, кода партнёра.
- `app/utils/helper.py` — генерация вариантов телефонных номеров для запросов в Bitrix24.
- `app/utils/workBitrix24.py` — асинхронный клиент Bitrix24: все идентификаторы полей (код/процент контакта и компании, типы, ссылка сделки) берутся из `Settings`; поиск партнёра по телефону сначала проходит по контактам, затем по компаниям, в обоих случаях подтягиваются код и процент, `fetch_partner_percent` извлекает процент по `contact_id`.