# Архитектура проекта utm_partner_binding

## Общее описание

Сервис построен на `FastAPI` и обрабатывает webhook от Bitrix24 для автоматической привязки партнеров к сделкам и лидам на основе UTM метки `utm_term`. Использует `fast-bitrix24` для работы с API Bitrix24, `loguru` для логирования, конфигурация загружается из `.env`.

## Структура

- `main.py` — основной файл с FastAPI приложением. Содержит:
  - Функцию парсинга запроса `_parse_request_data` для обработки различных форматов (JSON, form-urlencoded, raw body)
  - Функцию определения типа сущности по `document_id[1]` (CCrmDocumentDeal или CCrmDocumentLead)
  - Функцию извлечения ID из `document_id[2]` (обработка форматов 'DEAL_1', 'LEAD_1' или просто '1')
  - Функцию получения данных сделки/лида через Bitrix API
  - Функцию поиска партнера по коду (сначала в контактах, затем в компаниях)
  - Функции привязки партнера к сделке и лиду
  - Функции обновления кода партнера в контакте и компании (`_update_contact_partner_code`, `_update_company_partner_code`)
  - Endpoint `/webhook` для обработки хука от Bitrix24 (привязка партнеров по UTM меткам)
  - Endpoint `/webhook/deal` для обработки событий сделки (генерация кода партнера)
  - Endpoint `/` для проверки работы сервиса

- `bitrix_utils.py` — утилиты для работы с Bitrix24 API:
  - `update_deal_utm_term` — функция обновления UTM метки utm_term в сделке по ID
  - `update_lead_utm_term` — функция обновления UTM метки utm_term в лиде по ID
- `pyproject.toml` — управление зависимостями и метаданными проекта
- `.env` — переменные окружения (WEBHOOK, поля партнеров, поля привязки)
- `README.md` — инструкции по настройке и запуску
- `architecture.md` — описание архитектуры проекта

## Логика работы

### 1. Парсинг хука
- Получение данных из запроса через `_parse_request_data`
- Извлечение типа сущности из `document_id[1]`:
  - `CCrmDocumentDeal` → сделка
  - `CCrmDocumentLead` → лид
- Извлечение ID из `document_id[2]` с обработкой различных форматов
- Получение webhook URL из `auth[client_endpoint]` или из `.env`

### 2. Получение данных сущности
- Вызов `crm.deal.get` для сделок или `crm.lead.get` для лидов
- Извлечение поля `UTM_TERM` (стандартное поле Bitrix24)
- Проверка наличия UTM метки

### 3. Поиск партнера
- Поиск в контактах по полю `PARTNER_CONTACT_CODE_FIELD` с фильтром по коду из UTM
- Если не найдено — поиск в компаниях по полю `PARTNER_COMPANY_CODE_FIELD`
- Возврат типа сущности ('contact' или 'company') и ID партнера

### 4. Привязка партнера
- Для сделок: установка поля `PARTNER_DEAL_REF_DEAL` в формате `C_{partner_id}` (контакт) или `CO_{partner_id}` (компания)
- Для лидов: установка поля `PARTNER_LEAD_REF_LEAD` в том же формате
- Вызов `crm.deal.update` или `crm.lead.update` для обновления сущности

## Логика работы endpoint `/webhook/deal`

### 1. Парсинг webhook события сделки
- Получение данных из запроса через `_parse_request_data`
- Извлечение ID сделки из различных возможных форматов:
  - `data[FIELDS][ID]`
  - `data[ID]`
  - `document_id[2]` (с обработкой форматов)
  - `FIELDS[ID]`
  - `ID` (прямой ключ)
- Получение webhook URL из данных хука или из `.env`

### 2. Получение данных сделки
- Вызов `crm.deal.get` для получения данных сделки
- Извлечение полей `CONTACT_ID` и `COMPANY_ID`

### 3. Генерация кода партнера
- Если привязан контакт (`CONTACT_ID`):
  - Генерация кода по шаблону `ai-{contact_id}`
  - Обновление поля `PARTNER_CONTACT_CODE_FIELD` в контакте через `crm.contact.update`
- Если привязана компания (`COMPANY_ID`):
  - Генерация кода по шаблону `ai-{company_id}`
  - Обновление поля `PARTNER_COMPANY_CODE_FIELD` в компании через `crm.company.update`

### 4. Возврат результата
- Возврат JSON ответа с информацией об успешности обновления для каждого типа сущности (контакт/компания)

## Обработка ошибок

- Логирование всех операций через `loguru`
- Обработка ошибок API Bitrix24 с детальным логированием
- Проверка наличия UTM метки перед поиском партнера
- Проверка существования партнера перед привязкой
- Возврат JSON ответа с информацией об успехе/ошибке

## Особенности

- Поддержка различных форматов ID (с префиксом 'DEAL_'/'LEAD_' или без)
- Определение типа сущности по `document_id[1]` для правильной обработки
- Использование webhook URL из хука или из переменных окружения
- Логирование всех этапов обработки для отладки
- Поддержка различных форматов webhook событий для endpoint `/webhook/deal`
- Автоматическая генерация кода партнера по шаблону `ai-{id}` при обработке событий сделки

